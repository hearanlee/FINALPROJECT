<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì„± ì£¼ë¬¸ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .voice-interface {
            margin: 30px 0;
        }

        .speaker-icon {
            font-size: 3em;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ë©”ë‰´ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .menu-categories {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .category-btn {
            padding: 15px 25px;
            border: 3px solid #007bff;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #007bff;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .category-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .category-btn:hover::before {
            left: 100%;
        }

        .category-btn:hover {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .category-btn.active {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .menu-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .menu-item {
            border: 2px solid #e9ecef;
            border-radius: 20px;
            padding: 25px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #007bff, #28a745, #ffc107, #dc3545);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .menu-item:hover::before {
            transform: scaleX(1);
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        .menu-item h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 20px;
            font-weight: 700;
            line-height: 1.3;
        }

        .menu-item p {
            color: #6c757d;
            line-height: 1.5;
            margin: 10px 0;
            font-size: 14px;
        }

        .menu-item .price {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin: 15px 0;
            text-align: center;
            background: linear-gradient(135deg, #007bff, #0056b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .menu-item button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .menu-item button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .menu-item button:hover::before {
            width: 300px;
            height: 300px;
        }

        .menu-item button:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(40, 167, 69, 0.4);
        }

        .menu-item button:active {
            transform: translateY(0);
        }

        /* ì˜µì…˜ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .selected-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .selected-item h3 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .selected-item p {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }

        .option-section {
            margin-bottom: 20px;
        }

        .option-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 16px;
        }

        .option-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 0;
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }

        .option-item.selected {
            border-color: #007bff;
            background: #e3f2fd;
            color: #007bff;
        }

        .option-item span:first-child {
            font-weight: 500;
        }

        .option-item span:last-child {
            font-weight: bold;
            color: #28a745;
        }

        .selected-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 3px 0;
            background: #e3f2fd;
            border: 1px solid #007bff;
            border-radius: 6px;
            font-size: 14px;
        }

        .selected-option span:first-child {
            color: #007bff;
            font-weight: 500;
        }

        .selected-option span:last-child {
            color: #28a745;
            font-weight: bold;
        }

        .option-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .option-actions button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-actions button:first-child {
            background: #6c757d;
            color: white;
        }

        .option-actions button:first-child:hover {
            background: #5a6268;
        }

        .option-actions button:last-child {
            background: #dc3545;
            color: white;
        }

        .option-actions button:last-child:hover {
            background: #c82333;
        }

        .status-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 20px;
            min-height: 30px;
        }

        .subtitle {
            font-size: 1.1em;
            color: #333;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            min-height: 50px;
            line-height: 1.5;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .subtitle.speaking {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            animation: pulse 1s infinite;
        }

        .subtitle.listening {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
            animation: pulse 1s infinite;
        }

        .microphone {
            width: 120px;
            height: 120px;
            border: 4px solid #667eea;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .microphone:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .microphone.listening {
            animation: listening 1s infinite;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }

        @keyframes listening {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .mic-icon {
            font-size: 3em;
            color: white;
        }

        .user-input {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            min-height: 50px;
            font-size: 1.1em;
            color: #333;
        }

        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn.primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.secondary {
            background: #6c757d;
            color: white;
        }

        .btn.secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn.menu {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn.menu:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn.order {
            background: linear-gradient(135deg, #fd7e14, #e83e8c);
            color: white;
        }

        .btn.order:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(253, 126, 20, 0.4);
        }

        .footer {
            margin-top: 30px;
            color: #666;
            font-size: 0.9em;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .microphone {
                width: 100px;
                height: 100px;
            }
            
            .mic-icon {
                font-size: 2.5em;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ½ï¸ ìŒì„± ì£¼ë¬¸ ì‹œìŠ¤í…œ</h1>
        </div>
        
        <div class="voice-interface">
            <div class="speaker-icon" id="speakerIcon">ğŸ”Š</div>
            <div class="status-text" id="statusText">ìŒì„±ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤...</div>
            <div class="subtitle" id="subtitle"></div>
            <div class="microphone" id="microphone">
                <div class="mic-icon">ğŸ¤</div>
            </div>
            <div class="user-input" id="userInput"></div>
        </div>
        
        <div class="buttons">
            <button id="startBtn" class="btn primary">ğŸ¤ ìŒì„± ì‹œì‘í•˜ê¸°</button>
            <button id="stopBtn" class="btn secondary" disabled>ìŒì„± ì¸ì‹ ì¤‘ì§€</button>
            <button id="menuBtn" class="btn menu">ğŸ“‹ ë©”ë‰´ ë³´ê¸°</button>
            <button id="orderBtn" class="btn order">ğŸ›’ ì£¼ë¬¸í•˜ê¸°</button>
        </div>
        
        <div class="footer">
            <p>ğŸ¤ í˜ì´ì§€ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë§ˆì´í¬ë¥¼ í´ë¦­í•˜ì—¬ ìŒì„±ì„ ì‹œì‘í•˜ì„¸ìš”</p>
            <p>ê·¸ í›„ "ë©”ë‰´" ë˜ëŠ” "ì£¼ë¬¸"ì´ë¼ê³  ë§í•´ì£¼ì„¸ìš”</p>
        </div>
    </div>

    <!-- ë©”ë‰´ ëª¨ë‹¬ -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeMenuModal()">&times;</span>
            <h2>ğŸ½ï¸ ë©”ë‰´</h2>
            <div id="menuContent"></div>
        </div>
    </div>

    <!-- ì˜µì…˜ ì„ íƒ ëª¨ë‹¬ -->
    <div id="optionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOptionModal()">&times;</span>
            <h2>ì˜µì…˜ ì„ íƒ</h2>
            <div class="selected-item">
                <h3 id="selectedItemName"></h3>
                <p id="selectedItemPrice"></p>
            </div>
            <div class="option-section">
                <h4>ì„ íƒëœ ì˜µì…˜</h4>
                <div id="selectedOptions"></div>
            </div>
            <div class="option-section">
                <h4>ì¶”ê°€ ì˜µì…˜</h4>
                <div id="availableOptions"></div>
            </div>
            <div class="option-actions">
                <button onclick="resetOptions()">ì´ˆê¸°í™”</button>
                <button onclick="addToOrderWithOptions()">ì£¼ë¬¸ë‹´ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ì£¼ë¬¸ ëª¨ë‹¬ -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeOrderModal()">&times;</span>
            <h2>ğŸ›’ ì£¼ë¬¸í•˜ê¸°</h2>
            <div id="orderContent"></div>
        </div>
    </div>

    <script>
        // API í†µì‹ ì„ ìœ„í•œ ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ (ë°±ì—”ë“œ ì„œë²„ ì‚¬ìš©)
        class APIClient {
            constructor(baseURL = 'http://localhost:8000') {
                this.baseURL = baseURL;
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                try {
                    const response = await fetch(url, config);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API ìš”ì²­ ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            async getCategories() {
                return this.request('/categories');
            }

            async getMenuByCategory(categoryId) {
                return this.request(`/categories/${categoryId}/menu`);
            }

            async getMenuDetail(itemId) {
                return this.request(`/menu/${itemId}`);
            }

            async getOptionsByType(optionType) {
                return this.request(`/options/${optionType}`);
            }

            async createOrder(orderData) {
                return this.request('/orders', {
                    method: 'POST',
                    body: JSON.stringify(orderData)
                });
            }

            async getVoiceGuideText() {
                const data = await this.request('/voice-guide/text');
                return data.welcome_message || data.menu_guide || '';
            }
        }

        // ì „ì—­ ë³€ìˆ˜
        const apiClient = new APIClient();
        let recognition = null;
        let isListening = false;
        let isSpeaking = false;
        let hasUserInteracted = false;
        let isRecognitionActive = false;
        let categories = [];
        let menuItems = {};
        let orders = JSON.parse(localStorage.getItem('orders') || '[]');
        
        // í´ë°± ë°ì´í„° (ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
        const fallbackData = {
            categories: [
                { id: 1, name: "ìŒ€êµ­ìˆ˜", description: "ë§›ìˆëŠ” ìŒ€êµ­ìˆ˜ ë©”ë‰´" },
                { id: 2, name: "ëˆì¹´ì¸ ,ì¹´ë ˆ", description: "ëˆì¹´ì¸ ì™€ ì¹´ë ˆ ë©”ë‰´" },
                { id: 3, name: "1ì¸ì •ì‹", description: "1ì¸ìš© ì •ì‹ ë©”ë‰´" },
                { id: 4, name: "ì‚¬ì´ë“œ&ì¶”ê°€ë©”ë‰´", description: "ì‚¬ì´ë“œ ë©”ë‰´ì™€ ì¶”ê°€ ë©”ë‰´" }
            ],
            menuItems: {
                1: [
                    { id: 1, name: "ì°¨ëŒì–‘ì§€ìŒ€êµ­ìˆ˜", price: 12000, description: "ë¶€ë“œëŸ¬ìš´ ì°¨ëŒì–‘ì§€ê°€ ë“¤ì–´ê°„ ìŒ€êµ­ìˆ˜" },
                    { id: 2, name: "í•œìš°ìŒ€êµ­ìˆ˜", price: 15000, description: "í•œìš°ê°€ ë“¤ì–´ê°„ ìŒ€êµ­ìˆ˜" },
                    { id: 3, name: "ëª¨ë“¬ìŒ€êµ­ìˆ˜", price: 13000, description: "ë‹¤ì–‘í•œ ê³ ê¸°ê°€ ë“¤ì–´ê°„ ìŒ€êµ­ìˆ˜" }
                ],
                2: [
                    { id: 4, name: "í”„ë¦¬ë¯¸ì—„ ë¡œìŠ¤ì¹´ì¸ ", price: 18000, description: "í”„ë¦¬ë¯¸ì—„ ë¡œìŠ¤ì¹´ì¸ " },
                    { id: 5, name: "ì•ˆì‹¬ì¹´ì¸ ", price: 16000, description: "ë¶€ë“œëŸ¬ìš´ ì•ˆì‹¬ì¹´ì¸ " },
                    { id: 6, name: "í†µëª¨ì§œì¹˜ì¦ˆëˆì¹´ì¸ ", price: 17000, description: "í†µëª¨ì§œì¹˜ì¦ˆê°€ ë“¤ì–´ê°„ ëˆì¹´ì¸ " }
                ],
                3: [
                    { id: 7, name: "ì •ì‹A", price: 20000, description: "ì •ì‹A ì„¸íŠ¸" },
                    { id: 8, name: "ì •ì‹B", price: 22000, description: "ì •ì‹B ì„¸íŠ¸" },
                    { id: 9, name: "ì •ì‹C", price: 24000, description: "ì •ì‹C ì„¸íŠ¸" },
                    { id: 10, name: "ì •ì‹D", price: 26000, description: "ì •ì‹D ì„¸íŠ¸" }
                ],
                4: [
                    { id: 11, name: "ê³µê¹ƒë°¥ ì¶”ê°€", price: 2000, description: "ê³µê¹ƒë°¥ ì¶”ê°€" },
                    { id: 12, name: "ë ˆëª¬ì¶”ê°€", price: 1000, description: "ë ˆëª¬ ì¶”ê°€" },
                    { id: 13, name: "íŠ¸ëŸ¬í”Œì˜¤ì¼ ì¶”ê°€", price: 3000, description: "íŠ¸ëŸ¬í”Œì˜¤ì¼ ì¶”ê°€" }
                ]
            },
            voiceGuide: {
                welcome_message: "ì•ˆë…•í•˜ì„¸ìš”. ë°˜ê°‘ìŠµë‹ˆë‹¤. ì£¼ë¬¸í•˜ê³  ì‹¶ì€ ë©”ë‰´ê°€ ìˆìœ¼ì‹œë©´ ë©”ë‰´ëª…ì„ ë§ì”€í•´ì£¼ì‹œê³ , ëª» ì •í•˜ì…¨ìœ¼ë©´ 'ë©”ë‰´'ë¼ê³  ë§í•´ ì£¼ì„¸ìš”.",
                menu_guide: "ì €í¬ ë§¤ì¥ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ìŒ€êµ­ìˆ˜ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ ì°¨ëŒì–‘ì§€ìŒ€êµ­ìˆ˜, í•œìš°ìŒ€êµ­ìˆ˜, ëª¨ë“¬ìŒ€êµ­ìˆ˜ ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ëˆì¹´ì¸ ,ì¹´ë ˆ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ í”„ë¦¬ë¯¸ì—„ ë¡œìŠ¤ì¹´ì¸ , ì•ˆì‹¬ì¹´ì¸ , í†µëª¨ì§œì¹˜ì¦ˆëˆì¹´ì¸  ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. 1ì¸ì •ì‹ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ ì •ì‹A, ì •ì‹B, ì •ì‹C, ì •ì‹D ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œ&ì¶”ê°€ë©”ë‰´ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ ê³µê¹ƒë°¥ ì¶”ê°€, ë ˆëª¬ì¶”ê°€, íŠ¸ëŸ¬í”Œì˜¤ì¼ ì¶”ê°€ ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ì£¼ë¬¸í•˜ê³  ì‹¶ì€ ë©”ë‰´ê°€ ìˆìœ¼ì‹œë©´ ë©”ë‰´ëª…ì„ ë§ì”€í•´ì£¼ì„¸ìš”."
            }
        };

        // DOM ìš”ì†Œ
        const speakerIcon = document.getElementById('speakerIcon');
        const statusText = document.getElementById('statusText');
        const subtitle = document.getElementById('subtitle');
        const microphone = document.getElementById('microphone');
        const userInput = document.getElementById('userInput');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const menuBtn = document.getElementById('menuBtn');
        const orderBtn = document.getElementById('orderBtn');
        const menuModal = document.getElementById('menuModal');
        const orderModal = document.getElementById('orderModal');
        const optionModal = document.getElementById('optionModal');

        // ìŒì„± ì£¼ë¬¸ ì‹œìŠ¤í…œ í´ë˜ìŠ¤
        class VoiceOrderSystem {
            constructor() {
                this.initializeElements();
                this.setupEventListeners();
                this.initializeSpeechRecognition();
                this.showWelcomeMessage();
            }

            initializeElements() {
                // ì´ë¯¸ DOM ìš”ì†Œë“¤ì´ ì „ì—­ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆìŒ
            }

            setupEventListeners() {
                startBtn.addEventListener('click', () => {
                    hasUserInteracted = true;
                    this.speakWelcomeMessage();
                });
                stopBtn.addEventListener('click', () => this.stopListening());
                menuBtn.addEventListener('click', () => this.showMenuModal());
                orderBtn.addEventListener('click', () => this.showOrderModal());
                microphone.addEventListener('click', () => {
                    hasUserInteracted = true;
                    if (isListening) {
                        this.stopListening();
                    } else {
                        this.speakWelcomeMessage();
                    }
                });

                // í˜ì´ì§€ í´ë¦­ ì‹œ ìŒì„± ì‹œì‘
                document.addEventListener('click', () => {
                    if (!hasUserInteracted) {
                        hasUserInteracted = true;
                        this.speakWelcomeMessage();
                    }
                });

                // í‚¤ë³´ë“œ ì…ë ¥ ì‹œ ìŒì„± ì‹œì‘
                document.addEventListener('keydown', () => {
                    if (!hasUserInteracted) {
                        hasUserInteracted = true;
                        this.speakWelcomeMessage();
                    }
                });
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    recognition = new webkitSpeechRecognition();
                } else if ('SpeechRecognition' in window) {
                    recognition = new SpeechRecognition();
                } else {
                    statusText.textContent = 'ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.';
                    startBtn.disabled = true;
                    return;
                }

                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ko-KR';

                recognition.onstart = () => {
                    isListening = true;
                    isRecognitionActive = true;
                    this.updateUI();
                    statusText.textContent = 'ìŒì„±ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤...';
                    subtitle.textContent = 'ë§ì”€í•´ì£¼ì„¸ìš”...';
                    subtitle.className = 'subtitle listening';
                };

                recognition.onresult = (event) => {
                    const result = event.results[0][0].transcript.trim();
                    userInput.textContent = `ì¸ì‹ëœ ìŒì„±: "${result}"`;
                    isRecognitionActive = false;
                    this.processVoiceCommand(result);
                };

                recognition.onerror = (event) => {
                    console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                    statusText.textContent = 'ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                    isRecognitionActive = false;
                    this.stopListening();
                };

                recognition.onend = () => {
                    isListening = false;
                    isRecognitionActive = false;
                    this.updateUI();
                    subtitle.className = 'subtitle';
                };
            }

            showWelcomeMessage() {
                statusText.textContent = 'í˜ì´ì§€ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë§ˆì´í¬ë¥¼ í´ë¦­í•˜ì—¬ ìŒì„±ì„ ì‹œì‘í•˜ì„¸ìš”.';
                subtitle.textContent = '';
            }

        async speakWelcomeMessage() {
            try {
                const voiceGuideText = await apiClient.getVoiceGuideText();
                this.speak(voiceGuideText, () => {
                    statusText.textContent = 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•˜ì„¸ìš”.';
                    subtitle.className = 'subtitle listening';
                    setTimeout(() => {
                        this.startListening();
                    }, 500);
                });
            } catch (error) {
                console.error('ìŒì„± ê°€ì´ë“œ í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ë°±ì—”ë“œ):', error);
                console.log('í´ë°± ë°ì´í„° ì‚¬ìš©');
                const fallbackMessage = fallbackData.voiceGuide.welcome_message;
                this.speak(fallbackMessage, () => {
                    statusText.textContent = 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•˜ì„¸ìš”.';
                    subtitle.className = 'subtitle listening';
                    setTimeout(() => {
                        this.startListening();
                    }, 500);
                });
            }
        }

            speak(text, callback = null) {
                if (!hasUserInteracted) {
                    console.log('ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    if (callback) callback();
                    return;
                }

                if (isSpeaking) {
                    speechSynthesis.cancel();
                }

                isSpeaking = true;
                speakerIcon.style.animation = 'pulse 0.5s infinite';
                subtitle.textContent = text;
                subtitle.className = 'subtitle speaking';

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;

                const voices = speechSynthesis.getVoices();
                const koreanVoice = voices.find(voice => 
                    voice.lang.includes('ko') || voice.lang.includes('KR')
                );
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                }

                utterance.onstart = () => {
                    console.log('ìŒì„± ì¬ìƒ ì‹œì‘:', text);
                };

                utterance.onend = () => {
                    console.log('ìŒì„± ì¬ìƒ ì™„ë£Œ');
                    isSpeaking = false;
                    speakerIcon.style.animation = 'pulse 2s infinite';
                    subtitle.className = 'subtitle';
                    if (callback) callback();
                };

                utterance.onerror = (event) => {
                    console.error('ìŒì„± í•©ì„± ì˜¤ë¥˜:', event.error);
                    isSpeaking = false;
                    speakerIcon.style.animation = 'pulse 2s infinite';
                    subtitle.className = 'subtitle';
                    if (callback) callback();
                };

                speechSynthesis.speak(utterance);
            }

            startListening() {
                if (!recognition) {
                    statusText.textContent = 'ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                    return;
                }

                if (isSpeaking) {
                    console.log('ìŒì„± ì¬ìƒ ì¤‘ì´ë¯€ë¡œ ë§ˆì´í¬ í™œì„±í™”ë¥¼ ì§€ì—°í•©ë‹ˆë‹¤.');
                    setTimeout(() => {
                        this.startListening();
                    }, 1000);
                    return;
                }

                try {
                    recognition.start();
                } catch (error) {
                    console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜:', error);
                    statusText.textContent = 'ìŒì„± ì¸ì‹ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }
            }

            stopListening() {
                if (recognition && isListening) {
                    recognition.stop();
                    isListening = false;
                    isRecognitionActive = false;
                }
            }

            processVoiceCommand(command) {
                const lowerCommand = command.toLowerCase();
                
                if (lowerCommand.includes('ë©”ë‰´')) {
                    this.speak('ë©”ë‰´ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', () => {
                        this.showMenuModal();
                    });
                } else if (lowerCommand.includes('ì£¼ë¬¸')) {
                    this.speak('ì£¼ë¬¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', () => {
                        this.showOrderModal();
                    });
                } else {
                    // ë©”ë‰´ëª…ì„ ë§í•œ ê²½ìš°, ë°”ë¡œ ë©”ë‰´ ì²˜ë¦¬
                    this.handleDirectMenuCommand(command);
                }
            }

            // ì§ì ‘ ë©”ë‰´ëª… ì²˜ë¦¬ í•¨ìˆ˜
            handleDirectMenuCommand(command) {
                // ë©”ë‰´ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¨¼ì € ë¡œë“œ
                if (categories.length === 0 || Object.keys(menuItems).length === 0) {
                    this.loadMenuDataAndProcess(command);
                } else {
                    this.processDirectMenuCommand(command);
                }
            }

            // ë©”ë‰´ ë°ì´í„° ë¡œë“œ í›„ ì²˜ë¦¬
            async loadMenuDataAndProcess(command) {
                try {
                    await loadCategories();
                    await loadMenuItems();
                    this.processDirectMenuCommand(command);
                } catch (error) {
                    console.error('ë©”ë‰´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.speak('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', () => {
                            this.startListening();
                    });
                }
            }

            // ì§ì ‘ ë©”ë‰´ëª… ì²˜ë¦¬
            processDirectMenuCommand(command) {
                console.log('processDirectMenuCommand í˜¸ì¶œë¨:', command);
                // ë„ì–´ì“°ê¸°ì™€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ë©”ë‰´ëª… ë§¤ì¹­
                const normalizedCommand = command.replace(/\s+/g, '').toLowerCase();
                console.log('ì •ê·œí™”ëœ ëª…ë ¹ì–´:', normalizedCommand);
                
                // ëª¨ë“  ë©”ë‰´ ì•„ì´í…œì—ì„œ ë§¤ì¹­ ê²€ìƒ‰
                let matchedItem = null;
                let matchedCategory = null;
                for (const categoryId in menuItems) {
                    const items = menuItems[categoryId];
                    for (const item of items) {
                        const normalizedItemName = item.name.replace(/\s+/g, '').toLowerCase();
                        if (normalizedItemName.includes(normalizedCommand) || normalizedCommand.includes(normalizedItemName)) {
                            matchedItem = item;
                            matchedCategory = categories.find(cat => cat.id == categoryId);
                            console.log('ë§¤ì¹­ëœ ë©”ë‰´:', matchedItem.name, 'ì¹´í…Œê³ ë¦¬:', matchedCategory.name);
                            break;
                        }
                    }
                    if (matchedItem) break;
                }

                if (matchedItem && matchedCategory) {
                    console.log('ë©”ë‰´ ë§¤ì¹­ ì„±ê³µ, ì£¼ë¬¸ ê³¼ì • ì„¤ëª… ì‹œì‘');
                    // ë©”ë‰´ ì„¤ëª… ê³¼ì • ìƒëµí•˜ê³  ë°”ë¡œ ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ ì„¤ëª…
                    this.processMenuAfterGuide(matchedItem, matchedCategory);
                } else {
                    console.log('ë©”ë‰´ ë§¤ì¹­ ì‹¤íŒ¨, ì¼ë°˜ ë©”ë‰´ í˜ì´ì§€ë¡œ ì´ë™');
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° ì¼ë°˜ì ì¸ ë©”ë‰´ í˜ì´ì§€ë¡œ ì´ë™
                    this.speak('ë©”ë‰´ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', () => {
                        this.showMenuModal();
                    });
                }
            }

            // ë©”ë‰´ ì•ˆë‚´ í›„ ë©”ë‰´ ì²˜ë¦¬
            processMenuAfterGuide(matchedItem, matchedCategory) {
                console.log('processMenuAfterGuide í˜¸ì¶œë¨:', matchedItem.name, matchedCategory.name);
                // í•´ë‹¹ ë©”ë‰´ ì£¼ë¬¸ì„ ìœ„í•œ êµ¬ì²´ì ì¸ step-by-step ê°€ì´ë“œ
                let guideMessage = "";
                
                if (matchedCategory.name === 'ëˆì¹´ì¸ ,ì¹´ë ˆ') {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì˜µì…˜ì„ ì„ íƒí•œ í›„ ì£¼ë¬¸ë‹´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                } else if (matchedCategory.name === '1ì¸ì •ì‹') {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì˜µì…˜ì„ ì„ íƒí•œ í›„ ì£¼ë¬¸ë‹´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                } else if (matchedCategory.name === 'ìŒ€êµ­ìˆ˜') {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                } else if (matchedCategory.name === 'ì‚¬ì´ë“œ&ì¶”ê°€ë©”ë‰´') {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                } else {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                }
                
                console.log('ê°€ì´ë“œ ë©”ì‹œì§€:', guideMessage);
                
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(guideMessage);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 0.6;  // ë” ì²œì²œíˆ ë§í•˜ê¸°
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    const voices = speechSynthesis.getVoices();
                    const koreanVoice = voices.find(voice => 
                        voice.lang.includes('ko') || voice.lang.includes('KR')
                    );
                    if (koreanVoice) {
                        utterance.voice = koreanVoice;
                    }
                    
                    utterance.onend = () => {
                        // ê°€ì´ë“œ ì™„ë£Œ í›„ ë” ì´ìƒ ë§í•˜ì§€ ì•ŠìŒ
                        console.log('ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ ì„¤ëª… ì™„ë£Œ');
                    };
                    
                    speechSynthesis.speak(utterance);
                }
            }

            // ë§¤ì¹­ëœ ë©”ë‰´ ì²˜ë¦¬
            processMatchedMenu(matchedItem, matchedCategory) {
                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì„ íƒ
                this.selectCategoryAndProcessMenu(matchedCategory.id, matchedItem);
            }

            // ì¹´í…Œê³ ë¦¬ ì„ íƒ ë° ë©”ë‰´ ì²˜ë¦¬
            selectCategoryAndProcessMenu(categoryId, selectedItem) {
                // ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ í™œì„±í™”
                const categoryButtons = document.querySelectorAll('.category-btn');
                categoryButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.onclick.toString().includes(categoryId)) {
                        btn.classList.add('active');
                    }
                });

                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë©”ë‰´ í‘œì‹œ
                showCategoryMenu(categoryId);

                // ì„ íƒëœ ë©”ë‰´ ì²˜ë¦¬
                setTimeout(() => {
                    this.processSelectedMenu(selectedItem, categories.find(cat => cat.id == categoryId));
                }, 500);
            }

            // ì„ íƒëœ ë©”ë‰´ ì²˜ë¦¬
            processSelectedMenu(item, category) {
                if (category.name === 'ëˆì¹´ì¸ ,ì¹´ë ˆ' || category.name === '1ì¸ì •ì‹') {
                    // ì˜µì…˜ì´ ìˆëŠ” ë©”ë‰´ëŠ” ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
                    this.speak(`${category.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${item.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì˜µì…˜ì„ ì„ íƒí•œ í›„ ì£¼ë¬¸ë‹´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`, () => {
                        showOptionModal(item, category);
                    });
                } else {
                    // ì˜µì…˜ì´ ì—†ëŠ” ë©”ë‰´ëŠ” ìŒì„± ê°€ì´ë“œë§Œ ì œê³µ (ì£¼ë¬¸ ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
                    this.speak(`${category.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${item.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`, () => {
                        // ë§ˆì´í¬ ì¢…ë£Œ
                        if (recognition) {
                            recognition.stop();
                        }
                    });
                }
            }

            updateUI() {
                startBtn.disabled = isListening;
                stopBtn.disabled = !isListening;
                
                if (isListening) {
                    microphone.classList.add('listening');
                } else {
                    microphone.classList.remove('listening');
                }
            }

            async showMenuModal() {
                try {
                    await loadCategories();
                    await loadMenuItems();
                    renderMenuItems();
                    menuModal.style.display = 'block';
                    
                    // ìŒì„± ì…ë ¥ í‘œì‹œ ì˜ì—­ ì¶”ê°€ (ë©”ë‰´ ëª¨ë‹¬ìš©)
                    if (!document.getElementById('voiceInputDisplay')) {
                        const voiceInputDiv = document.createElement('div');
                        voiceInputDiv.id = 'voiceInputDisplay';
                        voiceInputDiv.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            background: rgba(0,0,0,0.8);
                            color: white;
                            padding: 15px;
                            border-radius: 10px;
                            font-size: 14px;
                            z-index: 1000;
                            display: none;
                            max-width: 300px;
                        `;
                        document.body.appendChild(voiceInputDiv);
                    }
                    
                    // ë©”ë‰´ ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ìƒì„¸í•œ ìŒì„± ì•ˆë‚´ ì œê³µ (í•œ ë²ˆë§Œ)
                    if (!window.menuVoicePlayed) {
                        try {
                            const voiceMessage = await apiClient.getVoiceGuideText();
                        
                        if (window.speechSynthesis) {
                            const utterance = new SpeechSynthesisUtterance(voiceMessage);
                            utterance.lang = 'ko-KR';
                            utterance.rate = 0.8;
                            utterance.pitch = 1;
                            utterance.volume = 1;
                            
                            const voices = speechSynthesis.getVoices();
                            const koreanVoice = voices.find(voice => 
                                voice.lang.includes('ko') || voice.lang.includes('KR')
                            );
                            if (koreanVoice) {
                                utterance.voice = koreanVoice;
                            }
                            
                    utterance.onend = () => {
                        // ìŒì„± ì•ˆë‚´ê°€ ì™„ì „íˆ ëë‚˜ë©´ ë§ˆì´í¬ í™œì„±í™”
                        console.log('ë©”ë‰´ ì•ˆë‚´ ìŒì„± ì™„ë£Œ, ë§ˆì´í¬ í™œì„±í™” ì¤€ë¹„ ì¤‘...');
                        setTimeout(() => {
                            console.log('ë§ˆì´í¬ í™œì„±í™” ì‹œì‘');
                            startMenuVoiceRecognition();
                        }, 2000);
                    };
                            
                            speechSynthesis.speak(utterance);
                            window.menuVoicePlayed = true;
                        }
                        } catch (error) {
                            console.error('ë©”ë‰´ ìŒì„± ê°€ì´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
                            // ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ë©”ì‹œì§€ ì‚¬ìš©
                            const fallbackMessage = "ì €í¬ ë§¤ì¥ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ìŒ€êµ­ìˆ˜ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ ì°¨ëŒì–‘ì§€ìŒ€êµ­ìˆ˜, í•œìš°ìŒ€êµ­ìˆ˜, ëª¨ë“¬ìŒ€êµ­ìˆ˜ ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ëˆì¹´ì¸ ,ì¹´ë ˆ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ í”„ë¦¬ë¯¸ì—„ ë¡œìŠ¤ì¹´ì¸ , ì•ˆì‹¬ì¹´ì¸ , í†µëª¨ì§œì¹˜ì¦ˆëˆì¹´ì¸  ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. 1ì¸ì •ì‹ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ ì •ì‹A, ì •ì‹B, ì •ì‹C, ì •ì‹D ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ì‚¬ì´ë“œ&ì¶”ê°€ë©”ë‰´ íƒ­ì„ ëˆ„ë¥´ì‹œë©´ ê³µê¹ƒë°¥ ì¶”ê°€, ë ˆëª¬ì¶”ê°€, íŠ¸ëŸ¬í”Œì˜¤ì¼ ì¶”ê°€ ë“±ì˜ ë©”ë‰´ê°€ ìˆìŠµë‹ˆë‹¤. ì£¼ë¬¸í•˜ê³  ì‹¶ì€ ë©”ë‰´ê°€ ìˆìœ¼ì‹œë©´ ë©”ë‰´ëª…ì„ ë§ì”€í•´ì£¼ì„¸ìš”.";
                            
                            if (window.speechSynthesis) {
                                const utterance = new SpeechSynthesisUtterance(fallbackMessage);
                                utterance.lang = 'ko-KR';
                                utterance.rate = 0.8;
                                utterance.pitch = 1;
                                utterance.volume = 1;
                                
                                const voices = speechSynthesis.getVoices();
                                const koreanVoice = voices.find(voice => 
                                    voice.lang.includes('ko') || voice.lang.includes('KR')
                                );
                                if (koreanVoice) {
                                    utterance.voice = koreanVoice;
                                }
                                
                                utterance.onend = () => {
                                    // ìŒì„± ì•ˆë‚´ê°€ ì™„ì „íˆ ëë‚˜ë©´ ë§ˆì´í¬ í™œì„±í™”
                                    console.log('ë©”ë‰´ ì•ˆë‚´ ìŒì„± ì™„ë£Œ, ë§ˆì´í¬ í™œì„±í™” ì¤€ë¹„ ì¤‘...');
                                    setTimeout(() => {
                                        console.log('ë§ˆì´í¬ í™œì„±í™” ì‹œì‘');
                                        startMenuVoiceRecognition();
                                    }, 2000);
                                };
                                
                                speechSynthesis.speak(utterance);
                                window.menuVoicePlayed = true;
                            }
                        }
                    } else {
                        // ì´ë¯¸ ìŒì„± ì•ˆë‚´ë¥¼ ì¬ìƒí–ˆë‹¤ë©´ ë°”ë¡œ ë§ˆì´í¬ í™œì„±í™”
                        setTimeout(() => {
                            startMenuVoiceRecognition();
                        }, 500);
                    }
                } catch (error) {
                    console.error('ë©”ë‰´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ë©”ë‰´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            showOrderModal() {
                renderOrderItems();
                orderModal.style.display = 'block';
            }
        }

        // ë©”ë‰´ ê´€ë ¨ í•¨ìˆ˜ë“¤
        async function loadCategories() {
            try {
                categories = await apiClient.getCategories();
                console.log('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì™„ë£Œ (ë°±ì—”ë“œ):', categories);
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨ (ë°±ì—”ë“œ):', error);
                console.log('í´ë°± ë°ì´í„° ì‚¬ìš©');
                categories = fallbackData.categories;
            }
        }

        async function loadMenuItems() {
            try {
                for (const category of categories) {
                    const items = await apiClient.getMenuByCategory(category.id);
                    menuItems[category.id] = items;
                }
                console.log('ë©”ë‰´ ì•„ì´í…œ ë¡œë“œ ì™„ë£Œ (ë°±ì—”ë“œ):', menuItems);
            } catch (error) {
                console.error('ë©”ë‰´ ì•„ì´í…œ ë¡œë“œ ì‹¤íŒ¨ (ë°±ì—”ë“œ):', error);
                console.log('í´ë°± ë°ì´í„° ì‚¬ìš©');
                menuItems = fallbackData.menuItems;
            }
        }

        function renderMenuItems() {
            const menuContent = document.getElementById('menuContent');
            if (!menuContent) return;

            let html = '<div class="menu-categories">';
            categories.forEach(category => {
                html += `<button class="category-btn" onclick="showCategoryMenu(${category.id})">${category.display_name}</button>`;
            });
            html += '</div>';

            html += '<div class="menu-items" id="menuItemsContainer"></div>';
            menuContent.innerHTML = html;
        }

        function showCategoryMenu(categoryId) {
            const menuItemsContainer = document.getElementById('menuItemsContainer');
            if (!menuItemsContainer) return;

            const items = menuItems[categoryId] || [];
            let html = '';
            
            items.forEach(item => {
                html += `
                    <div class="menu-item">
                        <h3>${item.name}</h3>
                        <p>${item.description || ''}</p>
                        <p class="price">${item.price.toLocaleString()}ì›</p>
                        <button onclick="addToOrder(${item.id}, '${item.name}', ${item.price})">ì£¼ë¬¸í•˜ê¸°</button>
                    </div>
                `;
            });

            menuItemsContainer.innerHTML = html;
            
            // ìŒì„± ì…ë ¥ í‘œì‹œ ì˜ì—­ ì¶”ê°€
            if (!document.getElementById('voiceInputDisplay')) {
                const voiceInputDiv = document.createElement('div');
                voiceInputDiv.id = 'voiceInputDisplay';
                voiceInputDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(0,0,0,0.8);
                    color: white;
                    padding: 15px;
                    border-radius: 10px;
                    font-size: 14px;
                    z-index: 1000;
                    display: none;
                    max-width: 300px;
                `;
                document.body.appendChild(voiceInputDiv);
            }
            
            // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ë°”ë¡œ ë§ˆì´í¬ í™œì„±í™” (ìŒì„± ì•ˆë‚´ ì¬ìƒí•˜ì§€ ì•ŠìŒ)
            setTimeout(() => {
                startMenuVoiceRecognition();
            }, 2000);
        }

        // ë©”ë‰´ ìŒì„± ì¸ì‹ ì‹œì‘
        function startMenuVoiceRecognition() {
            console.log('startMenuVoiceRecognition í˜¸ì¶œë¨');
            if (!recognition) {
                console.log('recognition ê°ì²´ê°€ ì—†ìŒ');
                return;
            }
            
            // ì´ë¯¸ ìŒì„± ì¸ì‹ì´ ì‹œì‘ëœ ìƒíƒœë¼ë©´ ì¤‘ì§€ í›„ ë‹¤ì‹œ ì‹œì‘
            if (isRecognitionActive) {
                console.log('ìŒì„± ì¸ì‹ì´ ì´ë¯¸ í™œì„±í™”ë¨, ì¤‘ì§€ í›„ ì¬ì‹œì‘');
                recognition.stop();
                setTimeout(() => {
                    startMenuVoiceRecognition();
                }, 100);
                return;
            }
            
            // ìŒì„± ì¸ì‹ ìƒíƒœ í‘œì‹œ
            const voiceInputDisplay = document.getElementById('voiceInputDisplay');
            if (voiceInputDisplay) {
                voiceInputDisplay.textContent = 'ğŸ¤ ìŒì„±ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë©”ë‰´ëª…ì„ ë§ì”€í•´ì£¼ì„¸ìš”.';
                voiceInputDisplay.style.display = 'block';
                voiceInputDisplay.style.color = '#007bff';
            }
            
            // ìŒì„± ì¸ì‹ ì‹œì‘ ì „ ì ì‹œ ëŒ€ê¸°
            setTimeout(() => {
                if (recognition && !isRecognitionActive) {
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('ìŒì„± ì¸ì‹ ì‹œì‘ ì˜¤ë¥˜:', error);
                        // ì˜¤ë¥˜ ë°œìƒ ì‹œ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„
                        setTimeout(() => {
                            if (recognition && !isRecognitionActive) {
                                recognition.start();
                            }
                        }, 1000);
                    }
                }
            }, 1000);
            
            recognition.onstart = () => {
                console.log('ë©”ë‰´ ìŒì„± ì¸ì‹ ì‹œì‘');
                isRecognitionActive = true;
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = 'ğŸ¤ ìŒì„±ì„ ë“£ê³  ìˆìŠµë‹ˆë‹¤... ë©”ë‰´ëª…ì„ ë§ì”€í•´ì£¼ì„¸ìš”.';
                    voiceInputDisplay.style.color = '#007bff';
                }
            };
            
            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                console.log('ë©”ë‰´ ìŒì„± ì¸ì‹ ê²°ê³¼:', result);
                isRecognitionActive = false;
                handleMenuVoiceCommand(result);
            };
            
            recognition.onerror = (event) => {
                console.error('ë©”ë‰´ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                isRecognitionActive = false;
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = 'âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    voiceInputDisplay.style.color = '#dc3545';
                }
                
                // 2ì´ˆ í›„ ë‹¤ì‹œ ìŒì„± ì¸ì‹ ì‹œì‘
                setTimeout(() => {
                    startMenuVoiceRecognition();
                }, 2000);
            };
            
            recognition.onend = () => {
                console.log('ë©”ë‰´ ìŒì„± ì¸ì‹ ì¢…ë£Œ');
                isRecognitionActive = false;
            };
        }

        // ë©”ë‰´ ìŒì„± ëª…ë ¹ ì²˜ë¦¬
        function handleMenuVoiceCommand(command) {
            // ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸ í‘œì‹œ
            const voiceInputDisplay = document.getElementById('voiceInputDisplay');
            if (voiceInputDisplay) {
                voiceInputDisplay.textContent = `ì¸ì‹ëœ ìŒì„±: "${command}"`;
                voiceInputDisplay.style.display = 'block';
                voiceInputDisplay.style.color = '#ffffff';
            }

            // ë„ì–´ì“°ê¸°ì™€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ë©”ë‰´ëª… ë§¤ì¹­
            const normalizedCommand = command.replace(/\s+/g, '').toLowerCase();
            
            // ëª¨ë“  ë©”ë‰´ ì•„ì´í…œì—ì„œ ë§¤ì¹­ ê²€ìƒ‰
            let matchedItem = null;
            let matchedCategory = null;
            for (const categoryId in menuItems) {
                const items = menuItems[categoryId];
                for (const item of items) {
                    const normalizedItemName = item.name.replace(/\s+/g, '').toLowerCase();
                    if (normalizedItemName.includes(normalizedCommand) || normalizedCommand.includes(normalizedItemName)) {
                        matchedItem = item;
                        matchedCategory = categories.find(cat => cat.id == categoryId);
                        break;
                    }
                }
                if (matchedItem) break;
            }

            if (matchedItem && matchedCategory) {
                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = `âœ… "${matchedItem.name}" ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!`;
                    voiceInputDisplay.style.color = '#28a745';
                }
                
                // ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ ìŒì„± ì•ˆë‚´ (ì²œì²œíˆ)
                let guideMessage = '';
                
                if (matchedCategory.name === 'ëˆì¹´ì¸ ,ì¹´ë ˆ') {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì˜µì…˜ì„ ì„ íƒí•œ í›„ ì£¼ë¬¸ë‹´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                } else if (matchedCategory.name === '1ì¸ì •ì‹') {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì˜µì…˜ì„ ì„ íƒí•œ í›„ ì£¼ë¬¸ë‹´ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                } else {
                    guideMessage = `${matchedCategory.name} íƒ­ì„ ëˆ„ë¥´ì‹œê³  ${matchedItem.name}ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
                }
                
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(guideMessage);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 0.6;  // ì²œì²œíˆ ë§í•˜ê¸°
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    const voices = speechSynthesis.getVoices();
                    const koreanVoice = voices.find(voice => 
                        voice.lang.includes('ko') || voice.lang.includes('KR')
                    );
                    if (koreanVoice) {
                        utterance.voice = koreanVoice;
                    }
                    
                    utterance.onend = () => {
                        // ê°€ì´ë“œ ì™„ë£Œ í›„ ë” ì´ìƒ ë§í•˜ì§€ ì•ŠìŒ
                        console.log('ì£¼ë¬¸ í”„ë¡œì„¸ìŠ¤ ì„¤ëª… ì™„ë£Œ');
                        // ë§ˆì´í¬ ì¢…ë£Œ
                        if (recognition) {
                            recognition.stop();
                        }
                    };
                    
                    speechSynthesis.speak(utterance);
                }
                
                // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    if (voiceInputDisplay) {
                        voiceInputDisplay.style.display = 'none';
                    }
                }, 3000);
            } else {
                // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš°
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = `âŒ "${command}" ë©”ë‰´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.`;
                    voiceInputDisplay.style.color = '#dc3545';
                }
                
                // 2ì´ˆ í›„ ë‹¤ì‹œ ìŒì„± ì¸ì‹ ì‹œì‘
                setTimeout(() => {
                    startMenuVoiceRecognition();
                }, 2000);
            }
        }

        // ì˜µì…˜ ì„ íƒì„ ìœ„í•œ ìŒì„± ì¸ì‹ ì‹œì‘
        function startOptionVoiceRecognition(selectedItem, selectedCategory) {
            if (!recognition) return;
            
            // ì˜µì…˜ ì„ íƒ ìƒíƒœ í‘œì‹œ
            const voiceInputDisplay = document.getElementById('voiceInputDisplay');
            if (voiceInputDisplay) {
                voiceInputDisplay.textContent = `ğŸ¤ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”...`;
                voiceInputDisplay.style.display = 'block';
                voiceInputDisplay.style.color = '#007bff';
            }
            
            // ì˜µì…˜ ì„ íƒì„ ìœ„í•œ ìŒì„± ì¸ì‹ ì„¤ì •
            recognition.onresult = (event) => {
                const result = event.results[0][0].transcript;
                console.log('ì˜µì…˜ ìŒì„± ì¸ì‹ ê²°ê³¼:', result);
                handleOptionVoiceCommand(result, selectedItem, selectedCategory);
            };
            
            recognition.onerror = (event) => {
                console.error('ì˜µì…˜ ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = 'âŒ ì˜µì…˜ ìŒì„± ì¸ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    voiceInputDisplay.style.color = '#dc3545';
                }
                
                // 2ì´ˆ í›„ ë‹¤ì‹œ ì˜µì…˜ ìŒì„± ì¸ì‹ ì‹œì‘
                setTimeout(() => {
                    startOptionVoiceRecognition(selectedItem, selectedCategory);
                }, 2000);
            };
            
            recognition.onend = () => {
                console.log('ì˜µì…˜ ìŒì„± ì¸ì‹ ì¢…ë£Œ');
            };
            
            // ìŒì„± ì¸ì‹ ì‹œì‘ ì „ ì ì‹œ ëŒ€ê¸°
            setTimeout(() => {
                if (recognition) {
                    recognition.start();
                }
            }, 500);
        }

        // ì˜µì…˜ ìŒì„± ëª…ë ¹ ì²˜ë¦¬
        function handleOptionVoiceCommand(command, selectedItem, selectedCategory) {
            const voiceInputDisplay = document.getElementById('voiceInputDisplay');
            if (voiceInputDisplay) {
                voiceInputDisplay.textContent = `ì¸ì‹ëœ ì˜µì…˜: "${command}"`;
                voiceInputDisplay.style.display = 'block';
                voiceInputDisplay.style.color = '#ffffff';
            }

            // ë„ì–´ì“°ê¸°ì™€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ì˜µì…˜ëª… ë§¤ì¹­
            const normalizedCommand = command.replace(/\s+/g, '').toLowerCase();
            
            // ì˜µì…˜ ì •ì˜
            let availableOptions = [];
            if (selectedCategory.name === 'ëˆì¹´ì¸ ,ì¹´ë ˆ') {
                availableOptions = ['ë°¥ë§ì´', 'ë°¥ì¶”ê°€', 'ë ˆëª¬ì¶”ê°€', 'íŠ¸ëŸ¬í”Œì˜¤ì¼ì¶”ê°€'];
            } else if (selectedCategory.name === '1ì¸ì •ì‹') {
                availableOptions = ['ìŒ€êµ­ìˆ˜ì‚¬ì´ì¦ˆì—…', 'ë°¥ì¶”ê°€', 'ê³ ìˆ˜ì¶”ê°€', 'ë ˆëª¬ì¶”ê°€', 'íŠ¸ëŸ¬í”Œì˜¤ì¼ì¶”ê°€'];
            }
            
            // ì˜µì…˜ ë§¤ì¹­ ê²€ìƒ‰
            let matchedOption = null;
            for (const option of availableOptions) {
                const normalizedOption = option.replace(/\s+/g, '').toLowerCase();
                if (normalizedOption.includes(normalizedCommand) || normalizedCommand.includes(normalizedOption)) {
                    matchedOption = option;
                    break;
                }
            }

            if (matchedOption) {
                // ì˜µì…˜ ì„ íƒ ì„±ê³µ
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = `âœ… "${matchedOption}" ì˜µì…˜ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤!`;
                    voiceInputDisplay.style.color = '#28a745';
                }
                
                // ì˜µì…˜ ì„ íƒ ì™„ë£Œ ì•ˆë‚´
                const optionCompleteMessage = `${matchedOption} ì˜µì…˜ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ë¡œ ì˜µì…˜ì„ ì„ íƒí•˜ì‹œë ¤ë©´ ë§ì”€í•´ì£¼ì‹œê³ , ì˜µì…˜ ì„ íƒì„ ì™„ë£Œí•˜ì‹œë ¤ë©´ 'ì™„ë£Œ'ë¼ê³  ë§ì”€í•´ì£¼ì„¸ìš”.`;
                
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(optionCompleteMessage);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    const voices = speechSynthesis.getVoices();
                    const koreanVoice = voices.find(voice => 
                        voice.lang.includes('ko') || voice.lang.includes('KR')
                    );
                    if (koreanVoice) {
                        utterance.voice = koreanVoice;
                    }
                    
                    utterance.onend = () => {
                        // ê³„ì† ì˜µì…˜ ì„ íƒì„ ìœ„í•œ ìŒì„± ì¸ì‹ ì‹œì‘
                        setTimeout(() => {
                            startOptionVoiceRecognition(selectedItem, selectedCategory);
                        }, 1000);
                    };
                    
                    speechSynthesis.speak(utterance);
                }
                
                // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    if (voiceInputDisplay) {
                        voiceInputDisplay.style.display = 'none';
                    }
                }, 3000);
            } else if (normalizedCommand.includes('ì™„ë£Œ') || normalizedCommand.includes('ë')) {
                // ì˜µì…˜ ì„ íƒ ì™„ë£Œ
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = `âœ… ì˜µì…˜ ì„ íƒì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`;
                    voiceInputDisplay.style.color = '#28a745';
                }
                
                // ì£¼ë¬¸ ì¶”ê°€ ë° ì™„ë£Œ ì•ˆë‚´
                addToOrder(selectedItem.id, selectedItem.name, selectedItem.price);
                
                const orderCompleteMessage = `${selectedItem.name}ì´ ì£¼ë¬¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ë‹¨ì˜ ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`;
                
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance(orderCompleteMessage);
                    utterance.lang = 'ko-KR';
                    utterance.rate = 0.8;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    const voices = speechSynthesis.getVoices();
                    const koreanVoice = voices.find(voice => 
                        voice.lang.includes('ko') || voice.lang.includes('KR')
                    );
                    if (koreanVoice) {
                        utterance.voice = koreanVoice;
                    }
                    
                    utterance.onend = () => {
                        // ì˜µì…˜ ì„ íƒ ì™„ë£Œ í›„ ë§ˆì´í¬ ì¢…ë£Œ
                        if (recognition) {
                            recognition.stop();
                        }
                    };
                    
                    speechSynthesis.speak(utterance);
                }
                
                // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    if (voiceInputDisplay) {
                        voiceInputDisplay.style.display = 'none';
                    }
                }, 3000);
            } else {
                // ë§¤ì¹­ë˜ì§€ ì•Šì€ ì˜µì…˜
                if (voiceInputDisplay) {
                    voiceInputDisplay.textContent = `âŒ "${command}" ì˜µì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§ì”€í•´ì£¼ì„¸ìš”.`;
                    voiceInputDisplay.style.color = '#dc3545';
                }
                
                // 2ì´ˆ í›„ ë‹¤ì‹œ ì˜µì…˜ ìŒì„± ì¸ì‹ ì‹œì‘
                setTimeout(() => {
                    startOptionVoiceRecognition(selectedItem, selectedCategory);
                }, 2000);
            }
        }

        async function addToOrder(itemId, itemName, price) {
            try {
                const menuDetail = await apiClient.getMenuDetail(itemId);
                
                if (menuDetail.available_options && menuDetail.available_options.length > 0) {
                    showOptionModal(menuDetail);
                } else {
                    addItemToOrder(itemId, itemName, price, []);
                }
            } catch (error) {
                console.error('ë©”ë‰´ ìƒì„¸ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                // ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ì˜µì…˜ ì—†ì´ ì£¼ë¬¸ì— ì¶”ê°€
                addItemToOrder(itemId, itemName, price, []);
            }
        }

        function addItemToOrder(itemId, itemName, price, selectedOptions) {
            const newItem = {
                id: itemId,
                name: itemName,
                price: price,
                quantity: 1,
                options: selectedOptions,
                totalPrice: price + selectedOptions.reduce((sum, opt) => sum + opt.price, 0)
            };

            const existingItem = orders.find(item => 
                item.id === itemId && 
                JSON.stringify(item.options) === JSON.stringify(selectedOptions)
            );

            if (existingItem) {
                existingItem.quantity += 1;
                existingItem.totalPrice = existingItem.price * existingItem.quantity + 
                    existingItem.options.reduce((sum, opt) => sum + opt.price * opt.quantity, 0);
            } else {
                orders.push(newItem);
            }

            localStorage.setItem('orders', JSON.stringify(orders));
            alert(`${itemName}ì´(ê°€) ì£¼ë¬¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        function showOptionModal(menuDetail) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>${menuDetail.name}</h3>
                    <p>ê°€ê²©: ${menuDetail.price.toLocaleString()}ì›</p>
                    <div class="options">
                        <h4>ì˜µì…˜ ì„ íƒ</h4>
                        ${menuDetail.available_options.map(option => `
                            <label class="option-item">
                                <input type="checkbox" value="${option.id}" data-price="${option.price}">
                                <span>${option.name} (+${option.price.toLocaleString()}ì›)</span>
                            </label>
                        `).join('')}
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn secondary" onclick="this.closest('.modal').remove()">ì·¨ì†Œ</button>
                        <button class="btn primary" onclick="confirmOptionSelection(${menuDetail.id}, '${menuDetail.name}', ${menuDetail.price}, this.closest('.modal'))">ì£¼ë¬¸ë‹´ê¸°</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmOptionSelection(itemId, itemName, basePrice, modal) {
            const checkboxes = modal.querySelectorAll('input[type="checkbox"]:checked');
            const selectedOptions = Array.from(checkboxes).map(cb => ({
                option_id: parseInt(cb.value),
                quantity: 1,
                price: parseInt(cb.dataset.price),
                name: cb.nextElementSibling.textContent.split(' (+')[0]
            }));

            addItemToOrder(itemId, itemName, basePrice, selectedOptions);
            modal.remove();
        }

        // ì£¼ë¬¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function renderOrderItems() {
            const orderContent = document.getElementById('orderContent');
            if (!orderContent) return;

            if (orders.length === 0) {
                orderContent.innerHTML = '<p>ì£¼ë¬¸ ëª©ë¡ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '<div class="order-items">';
            let totalAmount = 0;

            orders.forEach((item, index) => {
                const itemTotal = item.totalPrice || item.price;
                totalAmount += itemTotal * item.quantity;
                
                const optionsText = item.options && item.options.length > 0 
                    ? `<div class="item-options">ì˜µì…˜: ${item.options.map(opt => opt.name).join(', ')}</div>`
                    : '';

                html += `
                    <div class="order-item">
                        <h4>${item.name}</h4>
                        ${optionsText}
                        <p>ìˆ˜ëŸ‰: ${item.quantity}ê°œ</p>
                        <p>ê°€ê²©: ${itemTotal.toLocaleString()}ì›</p>
                        <button onclick="removeOrderItem(${index})">ì‚­ì œ</button>
                    </div>
                `;
            });

            html += `</div>
                <div class="order-summary">
                    <h3>ì´ ê¸ˆì•¡: ${totalAmount.toLocaleString()}ì›</h3>
                    <button class="btn primary" onclick="confirmOrder()">ì£¼ë¬¸ í™•ì¸</button>
                </div>`;

            orderContent.innerHTML = html;
        }

        function removeOrderItem(index) {
            orders.splice(index, 1);
            localStorage.setItem('orders', JSON.stringify(orders));
            renderOrderItems();
        }

        async function confirmOrder() {
            if (orders.length === 0) {
                alert('ì£¼ë¬¸í•  ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const totalAmount = orders.reduce((sum, item) => sum + (item.totalPrice || item.price) * item.quantity, 0);
            const confirmMessage = `ì£¼ë¬¸ì„ í™•ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ê¸ˆì•¡: ${totalAmount.toLocaleString()}ì›`;

            if (confirm(confirmMessage)) {
                try {
                    const orderData = {
                        items: orders.map(item => ({
                            menu_item_id: item.id,
                            quantity: item.quantity,
                            options: item.options || []
                        }))
                    };

                    const response = await apiClient.createOrder(orderData);
                    alert(`ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì£¼ë¬¸ë²ˆí˜¸: ${response.order_number}\nì´ ê¸ˆì•¡: ${response.total_amount.toLocaleString()}ì›`);
                    
                    orders = [];
                    localStorage.removeItem('orders');
                    closeOrderModal();
                } catch (error) {
                    console.error('ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
                    // ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ì£¼ë¬¸ ì™„ë£Œ ì²˜ë¦¬
                    const orderNumber = `ORD-${Date.now()}`;
                    alert(`ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì£¼ë¬¸ë²ˆí˜¸: ${orderNumber}\nì´ ê¸ˆì•¡: ${totalAmount.toLocaleString()}ì›`);
                    
                    orders = [];
                    localStorage.removeItem('orders');
                    closeOrderModal();
                }
            }
        }

        // ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤
        function closeMenuModal() {
            menuModal.style.display = 'none';
        }

        function closeOrderModal() {
            orderModal.style.display = 'none';
        }

        function closeOptionModal() {
            optionModal.style.display = 'none';
        }

        // ì˜µì…˜ ëª¨ë‹¬ í‘œì‹œ
        function showOptionModal(item, category) {
            const selectedItemName = document.getElementById('selectedItemName');
            const selectedItemPrice = document.getElementById('selectedItemPrice');
            const availableOptions = document.getElementById('availableOptions');
            
            selectedItemName.textContent = item.name;
            selectedItemPrice.textContent = `${item.price.toLocaleString()}ì›`;
            
            // ì˜µì…˜ ëª©ë¡ ìƒì„±
            let optionsHtml = '';
            if (category.name === 'ëˆì¹´ì¸ ,ì¹´ë ˆ') {
                const options = [
                    { name: 'ë°¥ë§ì´', price: 0 },
                    { name: 'ë°¥ì¶”ê°€', price: 1000 },
                    { name: 'ë ˆëª¬ì¶”ê°€', price: 500 },
                    { name: 'íŠ¸ëŸ¬í”Œì˜¤ì¼ ì¶”ê°€', price: 500 }
                ];
                options.forEach(option => {
                    optionsHtml += `
                        <div class="option-item" onclick="toggleOption('${option.name}', ${option.price})">
                            <span>${option.name}</span>
                            <span>+${option.price.toLocaleString()}ì›</span>
                        </div>
                    `;
                });
            } else if (category.name === '1ì¸ì •ì‹') {
                const options = [
                    { name: 'ìŒ€êµ­ìˆ˜ì‚¬ì´ì¦ˆì—…', price: 3000 },
                    { name: 'ë°¥ì¶”ê°€', price: 1000 },
                    { name: 'ê³ ìˆ˜ì¶”ê°€', price: 500 },
                    { name: 'ë ˆëª¬ì¶”ê°€', price: 500 },
                    { name: 'íŠ¸ëŸ¬í”Œì˜¤ì¼ ì¶”ê°€', price: 500 }
                ];
                options.forEach(option => {
                    optionsHtml += `
                        <div class="option-item" onclick="toggleOption('${option.name}', ${option.price})">
                            <span>${option.name}</span>
                            <span>+${option.price.toLocaleString()}ì›</span>
                        </div>
                    `;
                });
            }
            
            availableOptions.innerHTML = optionsHtml;
            optionModal.style.display = 'block';
        }

        // ì˜µì…˜ í† ê¸€
        function toggleOption(optionName, optionPrice) {
            const selectedOptions = document.getElementById('selectedOptions');
            const optionItems = document.querySelectorAll('.option-item');
            
            // ì˜µì…˜ ì•„ì´í…œ ì°¾ê¸°
            let optionItem = null;
            optionItems.forEach(item => {
                if (item.textContent.includes(optionName)) {
                    optionItem = item;
                }
            });
            
            if (optionItem) {
                if (optionItem.classList.contains('selected')) {
                    // ì„ íƒ í•´ì œ
                    optionItem.classList.remove('selected');
                    removeSelectedOption(optionName);
                } else {
                    // ì„ íƒ
                    optionItem.classList.add('selected');
                    addSelectedOption(optionName, optionPrice);
                }
            }
        }

        // ì„ íƒëœ ì˜µì…˜ ì¶”ê°€
        function addSelectedOption(optionName, optionPrice) {
            const selectedOptions = document.getElementById('selectedOptions');
            const optionDiv = document.createElement('div');
            optionDiv.className = 'selected-option';
            optionDiv.innerHTML = `
                <span>${optionName}</span>
                <span>+${optionPrice.toLocaleString()}ì›</span>
            `;
            selectedOptions.appendChild(optionDiv);
        }

        // ì„ íƒëœ ì˜µì…˜ ì œê±°
        function removeSelectedOption(optionName) {
            const selectedOptions = document.getElementById('selectedOptions');
            const options = selectedOptions.querySelectorAll('.selected-option');
            options.forEach(option => {
                if (option.textContent.includes(optionName)) {
                    option.remove();
                }
            });
        }

        // ì˜µì…˜ ì´ˆê¸°í™”
        function resetOptions() {
            const selectedOptions = document.getElementById('selectedOptions');
            const optionItems = document.querySelectorAll('.option-item');
            
            selectedOptions.innerHTML = '';
            optionItems.forEach(item => {
                item.classList.remove('selected');
            });
        }

        // ì˜µì…˜ê³¼ í•¨ê»˜ ì£¼ë¬¸ ì¶”ê°€
        function addToOrderWithOptions() {
            const selectedItemName = document.getElementById('selectedItemName').textContent;
            const selectedItemPrice = document.getElementById('selectedItemPrice').textContent;
            const selectedOptions = document.getElementById('selectedOptions');
            
            // ì„ íƒëœ ì˜µì…˜ë“¤ ìˆ˜ì§‘
            const options = [];
            const optionElements = selectedOptions.querySelectorAll('.selected-option');
            optionElements.forEach(option => {
                const name = option.children[0].textContent;
                const price = parseInt(option.children[1].textContent.replace(/[^0-9]/g, ''));
                options.push({ name, price });
            });
            
            // ì£¼ë¬¸ì— ì¶”ê°€
            addToOrder(0, selectedItemName, parseInt(selectedItemPrice.replace(/[^0-9]/g, '')));
            
            // ëª¨ë‹¬ ë‹«ê¸°
            closeOptionModal();
            
            // ì™„ë£Œ ìŒì„± ì•ˆë‚´
            const completeMessage = `${selectedItemName}ì´ ì£¼ë¬¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í•˜ë‹¨ì˜ ê²°ì œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ê·¸ ë‹¤ìŒì— ì¹´ë“œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.`;
            
            if (window.speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance(completeMessage);
                utterance.lang = 'ko-KR';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                utterance.volume = 1;
                
                const voices = speechSynthesis.getVoices();
                const koreanVoice = voices.find(voice => 
                    voice.lang.includes('ko') || voice.lang.includes('KR')
                );
                if (koreanVoice) {
                    utterance.voice = koreanVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            if (event.target === menuModal) {
                closeMenuModal();
            }
            if (event.target === orderModal) {
                closeOrderModal();
            }
            if (event.target === optionModal) {
                closeOptionModal();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŒì„± ì£¼ë¬¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            new VoiceOrderSystem();
        });
    </script>
</body>
</html>
